#include <avr/io.h>
#include <util/delay.h>
#include <avr/interrupt.h>

int count = 9;
int state = 1;
int ovr_count = 0;

ISR(INT0_vect)
{

    cli();
    _delay_ms(30);
    state = 1;
    count = 9;
    ovr_count = 0;
    PORTA = (PORTA & 0xF0) | 9; 
    PORTA &= ~(1 << PA4); //숫자카운트 상태에서 LED 비활성화

    sei();
    EIFR &= ~(1 << INTF0);
}

ISR(TIMER2_OVF_vect)
{
    TCNT2 = 156;
    if (state == 1) 
    {
        ovr_count++;
        PORTA &= ~(1 << PA4);
        
        if (ovr_count >= 20000)
        {
            ovr_count = 0;
            count--;

            if (count < 0)
            {
                state = 0;
                count = 0;
            }
        }
        PORTA = (PORTA & 0xF0) | count;
    }
    else //state 0
    {
        ovr_count++;
        if (ovr_count >= 2000)
        {
            ovr_count = 0;

            PORTA ^= (1 << PA4);
        }
    }
}

void Init_Timer2(void)
{
    TCCR2 = 1 << CS21;     // 일반 모드, 분주비 = 클럭/8
    TIMSK |= (1 << TOIE2); // Timer/Counter2 Overflow Interrupt Enable
    TCNT2 = 156;           // 카운터 값 설정(50us)
}

main()
{

    SREG |= 0x80;  // 전체 인터럽트 허가
    Init_Timer2(); // 타이머2 초기화
    DDRA |= (1 << DDA0);
    DDRA |= (1 << DDA1);
    DDRA |= (1 << DDA2);
    DDRA |= (1 << DDA3);
    DDRA |= (1 << DDA4); // led

    EIMSK |= 1 << INT0;
    EICRA |= 1 << ISC01;

    sei();

    while (1)
    {

        
    }
}
